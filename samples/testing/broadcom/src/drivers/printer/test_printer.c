/******************************************************************************
 *  Copyright (C) 2018 Broadcom. The term "Broadcom" refers to Broadcom Limited
 *  and/or its subsidiaries.
 *
 *  This program is the proprietary software of Broadcom and/or its licensors,
 *  and may only be used, duplicated, modified or distributed pursuant to the
 *  terms and conditions of a separate, written license agreement executed
 *  between you and Broadcom (an "Authorized License").  Except as set forth in
 *  an Authorized License, Broadcom grants no license (express or implied),
 *  right to use, or waiver of any kind with respect to the Software, and
 *  Broadcom expressly reserves all rights in and to the Software and all
 *  intellectual property rights therein.  IF YOU HAVE NO AUTHORIZED LICENSE,
 *  THEN YOU HAVE NO RIGHT TO USE THIS SOFTWARE IN ANY WAY, AND SHOULD
 *  IMMEDIATELY NOTIFY BROADCOM AND DISCONTINUE ALL USE OF THE SOFTWARE.
 *
 *  Except as expressly set forth in the Authorized License,
 *
 *  1.     This program, including its structure, sequence and organization,
 *  constitutes the valuable trade secrets of Broadcom, and you shall use all
 *  reasonable efforts to protect the confidentiality thereof, and to use this
 *  information only in connection with your use of Broadcom integrated circuit
 *  products.
 *
 *  2.     TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED
 *  "AS IS" AND WITH ALL FAULTS AND BROADCOM MAKES NO PROMISES, REPRESENTATIONS
 *  OR WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH
 *  RESPECT TO THE SOFTWARE.  BROADCOM SPECIFICALLY DISCLAIMS ANY AND ALL
 *  IMPLIED WARRANTIES OF TITLE, MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A
 *  PARTICULAR PURPOSE, LACK OF VIRUSES, ACCURACY OR COMPLETENESS, QUIET
 *  ENJOYMENT, QUIET POSSESSION OR CORRESPONDENCE TO DESCRIPTION. YOU ASSUME THE
 *  ENTIRE RISK ARISING OUT OF USE OR PERFORMANCE OF THE SOFTWARE.
 *
 *  3.     TO THE MAXIMUM EXTENT PERMITTED BY LAW, IN NO EVENT SHALL BROADCOM OR
 *  ITS LICENSORS BE LIABLE FOR (i) CONSEQUENTIAL, INCIDENTAL, SPECIAL,
 *  INDIRECT, OR EXEMPLARY DAMAGES WHATSOEVER ARISING OUT OF OR IN ANY WAY
 *  RELATING TO YOUR USE OF OR INABILITY TO USE THE SOFTWARE EVEN IF BROADCOM
 *  HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES; OR (ii) ANY AMOUNT IN
 *  EXCESS OF THE AMOUNT ACTUALLY PAID FOR THE SOFTWARE ITSELF OR U.S. $1,
 *  WHICHEVER IS GREATER. THESE LIMITATIONS SHALL APPLY NOTWITHSTANDING ANY
 *  FAILURE OF ESSENTIAL PURPOSE OF ANY LIMITED REMEDY.
 ******************************************************************************/

/*
 * @file test_thermal_printer.c
 * @brief bcm58202 printer tests
 */

#include <board.h>
#include <device.h>
#include <errno.h>
#include <broadcom/gpio.h>
#include <init.h>
#include <stdlib.h>
#include <stdbool.h>
#include <printer.h>
#include <string.h>
#include <zephyr/types.h>
#include <test.h>
#include <spi_legacy.h>
#include <broadcom/i2c.h>
#include <adc/adc.h>
#include <pinmux.h>


#define IO_EXPANDER_ADDR		0x20
#define IO_EXP_INPUT_REG_OFFSET		0x00
#define IO_EXP_OUTPUT_REG_OFFSET	0x08
#define IO_EXP_CONFIG_REG_OFFSET	0x18

#define IO_EXP_BANK_0			0x00
#define IO_EXP_BANK_1			0x01
#define IO_EXP_BANK_2			0x02
#define IO_EXP_BANK_3			0x03
#define IO_EXP_BANK_4			0x04

#define IO_EXP_B4_SPI3_SEL_PORT		0x02
#define IO_EXP_B0_GPIO_SMCC_PORT	0x06
#define IO_EXP_B0_GPIO_SMCD_PORT	0x07
#define IO_EXP_B2_UART3_SPI3_0_PORT	0x02
#define IO_EXP_B2_UART3_SPI3_1_PORT	0x03
#define IO_EXP_B4_PRINTER_PWREN		0x07

#if defined CONFIG_BOARD_SERP_CP
/* Thermistor connects to ADC_IN5 -> SoC ADC0_IN1
 * See rework info in CS-4456 for details
 */
#define PRINTER_TEMPERATURE_ADC		(0x0)
#define PRINTER_TEMPERATURE_ADC_CH	(0x0)
#else
#define PRINTER_TEMPERATURE_ADC		(0x02)
#define PRINTER_TEMPERATURE_ADC_CH	(0x01)
#endif
#define ADC_VALUE_AT_TEMPERATURE_70	(0x162)

/*
 * Each dot line have 48 bytes of data, totally, there are 384 dot.
 * Following array is hex equivalent of dot lines for printing CYGNUS
 * Each character is printed in 24x16 dot matrix
 * Each line can have 48 bytes of data. Cygnus requires 12 bytes per dot line
 * in a 24x16 dot matrix
 * Printing is centred such that there are 18 bytes of data before and after
 * Cygnus in each dot line
 */
u8_t line_cygnus[33][48] = {
	/* Add 3 blank dot lines before print CYGNUS symbol */
	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	/* Add 15 bytes blank dots (15*8 dots) before CYGNUS symbol,
	 * add 1 byte blank dots between each letter,
	 * add 16 bytes blank dots (16*8 dots) after CYGNUS symbol
	 */
	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
		0xFE, 0x00, 0xFF, 0xFE, 0x00, 0x60, 0x0E, 0x00,
		0xFF, 0xFE, 0x00, 0xFF, 0xFE, 0x00, 0xFE, 0xFE,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
		0xFE, 0x00, 0xFF, 0xFE, 0x00, 0x60, 0x0E, 0x00,
		0xFF, 0xFE, 0x00, 0xFF, 0xFE, 0x00, 0xFE, 0xFE,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x0E, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x78, 0x0E, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x7C, 0x0E, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x7E, 0x0E, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x77, 0x0E, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x77, 0x0E, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x73, 0x83, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x71, 0xCE, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0,
		0x00, 0x00, 0xE0, 0x0E, 0x00, 0x71, 0xCE, 0x00,
		0xE0, 0x0E, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
		0xFE, 0x00, 0xE0, 0x0E, 0x00, 0x71, 0xEE, 0x00,
		0xFC, 0x0E, 0x00, 0xFF, 0xFE, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
		0xFE, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0xEE, 0x00,
		0xFC, 0x0E, 0x00, 0xFF, 0xFE, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0xEE, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x7E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x7E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x3E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x3E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x3E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x1E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x1E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x1E, 0x00,
		0x00, 0x0E, 0x00, 0xE0, 0x0E, 0x00, 0x00, 0x0E,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
		0xFE, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x0E, 0x00,
		0xFF, 0xFE, 0x00, 0xE0, 0x0E, 0x00, 0xFF, 0xFE,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
		0xFE, 0x00, 0xE0, 0x0E, 0x00, 0x70, 0x0E, 0x00,
		0xFF, 0xFE, 0x00, 0xE0, 0x0E, 0x00, 0xFF, 0xFE,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	/* Add 6 blank dot lines after print CYGNUS symbol */
	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	},

	{
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	}
};

static union dev_config i2c_cfg = {
	.bits = {
		.use_10_bit_addr = 0,
		.is_master_device = 1,
		.speed = I2C_SPEED_STANDARD,
	},
};

static int test_i2c_read_io_expander(struct device *dev,
				     u8_t reg_addr, u8_t *val)
{
	struct i2c_msg msgs[2];
	u8_t raddr = reg_addr;

	msgs[0].buf = &raddr;
	msgs[0].len = 1;
	msgs[0].flags = I2C_MSG_WRITE;

	msgs[1].buf = val;
	msgs[1].len = 1;
	msgs[1].flags = I2C_MSG_READ | I2C_MSG_STOP;

	return i2c_transfer(dev, msgs, 2, IO_EXPANDER_ADDR);
}

static int test_i2c_write_io_expander(struct device *dev,
				      u8_t reg_addr, u8_t val)
{
	struct i2c_msg msgs;
	u8_t buff[2];
	u8_t value = val;

	buff[0] = reg_addr;
	buff[1] = value;
	msgs.buf = buff;
	msgs.len = 2;
	msgs.flags = I2C_MSG_WRITE | I2C_MSG_STOP;

	return i2c_transfer(dev, &msgs, 1, IO_EXPANDER_ADDR);
}

s32_t set_io_expander(struct device *dev, u8_t bank, u8_t port, u8_t bit)
{
	u8_t val;

	/* write data */
	test_i2c_read_io_expander(dev, (IO_EXP_OUTPUT_REG_OFFSET + bank), &val);
	if (bit)
		val |= BIT(port);
	else
		val &= ~BIT(port);
	test_i2c_write_io_expander(dev, (IO_EXP_OUTPUT_REG_OFFSET + bank), val);

	/* Set port as output */
	test_i2c_read_io_expander(dev, (IO_EXP_CONFIG_REG_OFFSET + bank), &val);
	val &= ~BIT(port);
	test_i2c_write_io_expander(dev, (IO_EXP_CONFIG_REG_OFFSET + bank), val);

	return 0;
}

static void printer_test(void)
{
	struct device *dev;
	struct device *spi_dev;
	struct device *pwr_dev;
	u8_t line;

	dev = device_get_binding(CONFIG_PRINTER_DEV_NAME);
	zassert_not_null(dev, "Printer Driver binding not found!");

	spi_dev = device_get_binding(CONFIG_SPI3_DEV_NAME);
	zassert_not_null(dev, "SPI3 Driver binding not found!");

#ifdef CONFIG_BOARD_CITADEL_SVK_58201
	pwr_dev = device_get_binding(CONFIG_I2C0_NAME);
	zassert_not_null(pwr_dev, "I2C Driver binding not found!");

	set_io_expander(pwr_dev, IO_EXP_BANK_4, IO_EXP_B4_PRINTER_PWREN, 1);
#elif defined CONFIG_BOARD_SERP_CP
	/* MFIO 45 (GPIO 8) controls the power to printer */
	pwr_dev = device_get_binding(CONFIG_GPIO_DEV_NAME_0);
	zassert_not_null(pwr_dev, "GPIO Driver binding not found!");
	gpio_pin_configure(pwr_dev, 8, GPIO_DIR_OUT);
	gpio_pin_write(pwr_dev, 8, 1);
#endif
	/* Print "CYGNUS" */
	for (line = 0; line < 33; line++) {
		zassert_true(printer_line_data_print(dev, spi_dev,
				 &line_cygnus[line][0], 48) == TC_PASS, NULL);
		printer_stepper_motor_run(dev, 2);
	}
	/* Leave space */
	for (line = 0; line < 30; line++) {
		printer_stepper_motor_run(dev, 2);
	}

	printer_stepper_motor_disable(dev);
#ifdef CONFIG_BOARD_CITADEL_SVK_58201
	set_io_expander(pwr_dev, IO_EXP_BANK_4, IO_EXP_B4_PRINTER_PWREN, 0);
#elif defined CONFIG_BOARD_SERP_CP
	gpio_pin_write(pwr_dev, 8, 0);
#endif
}

s32_t printer_temperature_check(void)
{
	struct device *adc;
	u16_t adc_val = 0;
	s32_t ret;

	adc = device_get_binding(CONFIG_ADC_NAME);
	if (adc == NULL) {
		TC_PRINT("Cannot get ADC device .. Skipping temp check\n");
		return 0;
	}

	/* Get ADC value */
	ret = adc_get_snapshot(adc, PRINTER_TEMPERATURE_ADC,
					PRINTER_TEMPERATURE_ADC_CH, &adc_val);
	zassert_true(ret == 0, "ADC value get failed");
	TC_PRINT("Printer temperature ADC value = 0x%x\n", adc_val);

	/*
	 * Record voltage of TP16 (SVK board), and get the voltage from ADC:
	 * 0.55V <--> 0x1a6 (Real temperature around 30 degree),
	 * 0.53V <--> 0x1a1 (Real temperature around 25 degree)
	 *
	 * Thermistor values from schematic:
	 * 1.6K OHM <--> 80 degree;
	 * 10K OHM <--> 25 degree;
	 * 85K OHM <--> -20 degree,
	 * it is about 3.1K OHM for 70 degree (Assume it is a linear).
	 *
	 * The voltage of TP16 is about (3.1K/(10K+3.1K)) * 1.2V = 0.28V,
	 * it is about 0x162
	 */

	if (adc_val < ADC_VALUE_AT_TEMPERATURE_70)
		return TC_FAIL;

	return TC_PASS;
}


SHELL_TEST_DECLARE(test_printer)
{
	struct device *i2c_dev;
	struct device *spi_dev;
	struct spi_config cfg;
	u8_t val;
	s32_t ret;

	ARG_UNUSED(argc);
	ARG_UNUSED(argv);
	spi_dev = device_get_binding(CONFIG_SPI3_DEV_NAME);
	zassert_not_null(spi_dev, "SPI3 Driver binding not found!");

	ret = printer_temperature_check();
	zassert_true(ret == 0, "Printer temperature test failed");

	/* Configure SPI */
	cfg.max_sys_freq = 10000;
	cfg.config = SPI_WORD(8);

	ret = spi_configure(spi_dev, &cfg);
	zassert_true(ret == 0, "Spi configure failed");

#ifdef CONFIG_BOARD_CITADEL_SVK_58201
	i2c_dev = device_get_binding(CONFIG_I2C0_NAME);
	zassert_not_null(i2c_dev, "I2C Driver binding not found!");

	ret = i2c_configure(i2c_dev, i2c_cfg.raw);
	zassert_true(ret == 0, "i2c configure returned error");

	set_io_expander(i2c_dev, IO_EXP_BANK_4, IO_EXP_B4_SPI3_SEL_PORT, 0);
	set_io_expander(i2c_dev, IO_EXP_BANK_2, IO_EXP_B2_UART3_SPI3_0_PORT, 0);
	set_io_expander(i2c_dev, IO_EXP_BANK_2, IO_EXP_B2_UART3_SPI3_1_PORT, 0);
	set_io_expander(i2c_dev, IO_EXP_BANK_0, IO_EXP_B0_GPIO_SMCC_PORT, 1);
	set_io_expander(i2c_dev, IO_EXP_BANK_0, IO_EXP_B0_GPIO_SMCD_PORT, 1);
	set_io_expander(i2c_dev, IO_EXP_BANK_4, IO_EXP_B4_PRINTER_PWREN, 0);


	test_i2c_read_io_expander(i2c_dev, (IO_EXP_OUTPUT_REG_OFFSET +
						IO_EXP_BANK_0), &val);
	val &= ~IO_EXP_B4_SPI3_SEL_PORT;
	test_i2c_write_io_expander(i2c_dev, (IO_EXP_OUTPUT_REG_OFFSET +
						IO_EXP_BANK_0), val);

	test_i2c_read_io_expander(i2c_dev, (IO_EXP_CONFIG_REG_OFFSET +
						IO_EXP_BANK_0), &val);
	val &= ~IO_EXP_B4_SPI3_SEL_PORT;
	test_i2c_write_io_expander(i2c_dev, (IO_EXP_CONFIG_REG_OFFSET +
						IO_EXP_BANK_0), val);
#elif defined CONFIG_BOARD_SERP_CP
	ARG_UNUSED(val);
	ARG_UNUSED(i2c_dev);
	ARG_UNUSED(i2c_cfg);
	/* STROBE pins 1 and 2 map to GPIO 32 & 33 (MFIO 0 & 1). So the MFI
	 * mode needs to be set to 3 to select GPIO function
	 */
	struct device *dev = device_get_binding(CONFIG_PINMUX_CITADEL_0_NAME);
	pinmux_pin_set(dev, 0, 3);
	pinmux_pin_set(dev, 1, 3);
#endif

	ztest_test_suite(printer_driver_tests, ztest_unit_test(printer_test));
	ztest_run_test_suite(printer_driver_tests);

	return 0;
}
